/**
 * @file Firestore Security Rules for the bakery canteen system.
 *
 * @core_philosophy This ruleset enforces a user-ownership model for user profiles
 * and allows public read access to inventory and orders.  All write operations
 * are restricted to authenticated users.  The rules prioritize security and
 * assume a flexible data structure for rapid iteration.
 *
 * @data_structure
 * - /users/{userId}: Stores individual user profiles.
 * - /orders/{orderId}: Stores order information.
 * - /inventory/{inventoryId}: Stores inventory data.
 *
 * @key_security_decisions
 * - User listing is disallowed.
 * - Inventory and orders are publicly readable but writable only by authenticated users.
 * - Data validation is limited to ownership checks and relationship enforcement.
 *
 * @denormalization_for_authorization
 * - Orders store the `user_id` to enable efficient owner-based access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages access to user profiles. Only the owner can read or write their own profile.
     * @path /users/{userId}
     * @allow (get, update, delete) User 'user123' can read, update, or delete their own profile.
     * @allow (create) User 'user123' can create their own profile if request.auth.uid == userId.
     * @deny (get, update, delete) User 'user456' cannot read, update, or delete user 'user123' profile.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages access to orders. Publicly readable, but only authenticated users can create orders. Only the user who created the order can update or delete it.
     * @path /orders/{orderId}
     * @allow (get, list) Any user can read order information.
     * @allow (create) Any signed-in user can create an order with a valid user_id.
     * @deny (update, delete) User 'user456' cannot update or delete order 'order123' created by user 'user123'.
     * @principle Public read, owner-only writes, relational integrity.
     */
    match /orders/{orderId} {
      function isOrderOwner() {
        return request.auth.uid == resource.data.user_id;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.user_id == request.auth.uid;
      allow update: if isSignedIn() && isOrderOwner();
      allow delete: if isSignedIn() && isOrderOwner();
    }

    /**
     * @description Manages access to inventory items. Publicly readable, but only authenticated users can create, update, or delete items.
     * @path /inventory/{inventoryId}
     * @allow (get, list) Any user can read inventory information.
     * @allow (create, update, delete) Any signed-in user can manage inventory items.
     * @principle Public read, authenticated-user-only writes.
     */
    match /inventory/{inventoryId} {
       function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}